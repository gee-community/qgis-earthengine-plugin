name: Release QGIS Plugin

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install qgis-plugin-ci

      - name: Vendor extlibs dependencies
        run: |
          # Install required Python packages into ee_plugin/extlibs
          pip install -r requirements.txt -t ee_plugin/extlibs
          find ee_plugin/extlibs -type d -name __pycache__ -exec rm -rf {} +
          # Optionally clean metadata folders
          find ee_plugin/extlibs -type d -name "*.dist-info" -exec rm -rf {} +

      - name: Get tag version
        run: |
          # Strip "refs/tags/" prefix, then leading "v"
          raw="${GITHUB_REF#refs/tags/}"
          export VERSION_TAG="${raw#v}"
          echo "TAG_NAME=$VERSION_TAG" >> $GITHUB_ENV

      - name: Package plugin
        run: |
          qgis-plugin-ci package "$VERSION_TAG" \
            --asset-path ee_plugin/extlibs

      - name: Check package size
        run: |
          MAX_SIZE=$((25 * 1024 * 1024))
          ZIP_FILE="ee_plugin.${VERSION_TAG}.zip"
          ACTUAL_SIZE=$(stat -c%s "$ZIP_FILE")
          echo "Package size: $ACTUAL_SIZE bytes"
          if [ "$ACTUAL_SIZE" -gt "$MAX_SIZE" ]; then
            echo "::error ::Package exceeds 25â€¯MB limit!"
            exit 1
          fi

      - name: Publish release
        run: |
          qgis-plugin-ci release "$TAG_NAME" \
            --github-token ${{ secrets.GITHUB_TOKEN }} \
            --create-plugin-repo
            --osgeo-user ${{ secrets.OSGEO_USER }} \
            --osgeo-pass ${{ secrets.OSGEO_PASS }} \ 